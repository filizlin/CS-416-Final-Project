<!DOCTYPE html>
<html>
<head>
  <title>Scatter Plot with D3.js</title>
  <!-- Include D3.js library -->
  <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
  <div>
    <label>Select Subgroup(s):</label>
    <select id="subgroupSelector" multiple>
      <option value="Subgroup 1">Subgroup 1</option>
      <option value="Subgroup 2">Subgroup 2</option>
      <option value="Subgroup 3">Subgroup 3</option>
      <!-- Add more options as needed -->
    </select>
  </div>
  <div id="scatterPlot"></div>

  <script>
    // Define the URL for the data
    const dataURL = 'https://raw.githubusercontent.com/filizlin/CS-416-Final-Project/main/Ethnic%20data.csv';

    // Define the size of the SVG canvas
    const width = 800;
    const height = 600;
    const margin = { top: 50, right: 50, bottom: 50, left: 50 };
    const innerWidth = width - margin.left - margin.right;
    const innerHeight = height - margin.top - margin.bottom;

    // Define the color scale for subgroups
    const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

    // Append the SVG canvas to the 'scatterPlot' div
    const svg = d3.select('#scatterPlot')
      .append('svg')
      .attr('width', width)
      .attr('height', height);

    // Create a group for the plot area
    const plotArea = svg.append('g')
      .attr('transform', `translate(${margin.left}, ${margin.top})`);

    // Fetch the data from the provided URL
    d3.csv(dataURL).then(data => {
      // Convert 'perc' to numbers
      data.forEach(d => {
        d.perc = +d.perc;
        d.academicYear = +d.academicYear;
      });

      // Define the scales for the axes
      const xScale = d3.scaleBand()
        .domain(data.map(d => d.academicYear))
        .range([0, innerWidth])
        .padding(0.1); // Add padding between bars

      const yScale = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.perc)])
        .range([innerHeight, 0])
        .nice();

      // Create the axes
      const xAxis = d3.axisBottom(xScale);
      const yAxis = d3.axisLeft(yScale);

      // Append the axes to the SVG
      plotArea.append('g')
        .attr('transform', `translate(0, ${innerHeight})`)
        .call(xAxis);

      plotArea.append('g')
        .call(yAxis);

      // Function to update the plot based on selected subgroups
      function updatePlot(selectedSubgroups) {
        // Filter data based on selected subgroups
        const filteredData = data.filter(d => selectedSubgroups.includes(d.subgroup));

        // Create the dots for the scatter plot
        const dots = plotArea.selectAll('circle')
          .data(filteredData, d => d.subgroup)
          .join(
            enter => enter.append('circle')
              .attr('cx', d => xScale(d.academicYear) + xScale.bandwidth() / 2) // Place dots in the center of each band
              .attr('cy', d => yScale(d.perc))
              .attr('r', 5)
              .attr('fill', d => colorScale(d.subgroup))
              .on('mouseover', showTooltip)
              .on('mouseout', hideTooltip),
            update => update,
            exit => exit.remove()
          );

        // Create the lines for connecting data points of the same subgroup
        const line = d3.line()
          .x(d => xScale(d.academicYear) + xScale.bandwidth() / 2)
          .y(d => yScale(d.perc));

        const lines = plotArea.selectAll('.line')
          .data(d3.groups(filteredData, d => d.subgroup))
          .join(
            enter => enter.append('path')
              .attr('class', 'line')
              .attr('d', d => line(d[1]))
              .attr('fill', 'none')
              .attr('stroke', d => colorScale(d[0])),
            update => update,
            exit => exit.remove()
          );
      }

      // Initial plot update with all subgroups shown
      const initialSubgroups = data.map(d => d.subgroup);
      updatePlot(initialSubgroups);

      // Handle subgroup selection change
      const subgroupSelector = document.getElementById('subgroupSelector');
      subgroupSelector.addEventListener('change', () => {
        const selectedSubgroups = Array.from(subgroupSelector.selectedOptions, option => option.value);
        updatePlot(selectedSubgroups);
      });

      // Tooltip
      const tooltip = d3.select('body')
        .append('div')
        .style('position', 'absolute')
        .style('padding', '8px')
        .style('background-color', 'rgba(0, 0, 0, 0.7)')
        .style('color', 'white')
        .style('font-size', '12px')
        .style('pointer-events', 'none')
        .style('opacity', 0);

      function showTooltip(event, d) {
        const tooltipContent = `
          Value: ${d.value}<br>
          Denom: ${d.denom}<br>
          Subgroup: ${d.subgroup}<br>
          Perc: ${d.perc}
        `;

        tooltip.html(tooltipContent)
          .style('left', (event.pageX + 10) + 'px')
          .style('top', (event.pageY - 10) + 'px')
          .style('opacity', 1);
      }

      function hideTooltip() {
        tooltip.style('opacity', 0);
      }

      // Legend for the color scale
      const legend = svg.append('g')
        .attr('transform', `translate(${width - margin.right - 100}, ${margin.top})`);

      const legendColor = legend.selectAll('circle')
        .data(colorScale.domain())
        .enter()
        .append('circle')
        .attr('cx', 0)
        .attr('cy', (d, i) => i * 20)
        .attr('r', 5)
        .attr('fill', d => colorScale(d));

      const legendLabel = legend.selectAll('text')
        .data(colorScale.domain())
        .enter()
        .append('text')
        .attr('x', 12)
        .attr('y', (d, i) => i * 20 + 5)
        .text(d => d);
    }).catch(error => {
      console.error('Error fetching data:', error);
    });
  </script>
</body>
</html>